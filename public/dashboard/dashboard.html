<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaTech | Dashboards</title>
    <link rel="stylesheet" href="./../css/dashboard.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>
    <!-- ... (resto do código) ... -->
</head>

<body>
    <div class="janela">
        <!-- ... (resto do código) ... -->
        <div class="dash">
            <div id="alerta">
            </div>
            <div class="btns-dash" id="btnAquario">
                <button class="btn-chart" onclick="obterDadosGrafico()" id="btnAquario1">
                    Gráfico do Jogo
                </button>
            </div>
            <div id="graficos">
                <div id="grafico1" class="display-block">
                    <h3 class="tituloGraficos">
                        <span id="tituloAquario1">Últimas medidas de Pontos do jogador <span style='color: #e6005a'>
                            </span></span>
                    </h3>
                    <div class="graph">
                        <canvas id="myChartCanvas1"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura1" style="color: white"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    // ... (resto do código) ... 
    // Função para obter os dados do gráfico do banco de dados
    function obterDadosGrafico() {
        let fkFazendeiro = 1;
        console.log(sessionStorage.ID_USUARIO);
        // Faz uma requisição para a API para obter os últimos dados do aquário
        fetch(`/ultimas/${fkFazendeiro}`, { cache: 'no-store' })
            .then(function (response) {
                if (response.ok) {
                    // Se a requisição for bem-sucedida, converte a resposta para JSON
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        // Plota o gráfico com os dados recebidos
                        plotarGrafico(resposta, 1);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    // Função para plotar o gráfico na página
    function plotarGrafico(resposta) {
        console.log('iniciando plotagem do gráfico...');
        // Cria a estrutura para plotar o gráfico - labels (eixo x)
        let labels = [];
        // Cria a estrutura para plotar o gráfico - dados (eixo y)
        let dados = {
            labels: labels,
            datasets: [
                {
                    label: 'Pontos',
                    data: [],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                },
            ],
        };
        console.log('----------------------------------------------');
        console.log(
            'Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":'
        );
        console.log(resposta);
        // Itera sobre cada registro de dados
        for (let i = 0; i < resposta.length; i++) {
            let registro = resposta[i];
            // Adiciona a data e hora do registro aos labels
            labels.push(registro.tempo);
            // Adiciona a umidade e a temperatura aos dados
            dados.datasets[0].data.push(registro.pontos);
        }
        console.log('----------------------------------------------');
        console.log('O gráfico será plotado com os respectivos valores:');
        console.log('Labels:');
        console.log(labels);
        console.log('Dados:');
        console.log(dados.datasets);
        console.log('----------------------------------------------');
        // Cria a configuração para o gráfico
        const config = {
            type: 'line', // Define o tipo de gráfico como linha
            data: dados, // Define os dados do gráfico
        };
        // Cria o gráfico e o adiciona à div na página
        let myChart = new Chart(document.getElementById(`myChartCanvas1`), config);
        // Define um intervalo para atualizar o gráfico após 2 segundos
        setTimeout(() => {
            // Cria uma cópia do objeto dados
            let dadosCopia = JSON.parse(JSON.stringify(dados)); // Cria uma cópia profunda
            atualizarGrafico(dadosCopia, myChart); // Passa a cópia para atualizarGrafico
        }, 2000);
    }
    // Função para atualizar o gráfico com novos dados
    function atualizarGrafico(dados, myChart) {
        let fkFazendeiro = 1;
        // Faz uma requisição para a API para obter o último dado do aquário
        fetch(`/tempo-real/${fkFazendeiro}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                // Se a requisição for bem-sucedida, converte a resposta para JSON
                response.json().then(function (novoRegistro) {
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);
                    let avisoCaptura = document.getElementById(`avisoCaptura1`);
                    avisoCaptura.innerHTML = "";
                    // Verifica se o novo dado capturado é igual ao último dado do gráfico
                    if (novoRegistro[0].tempo == dados.labels[dados.labels.length - 1]) {
                        console.log("----------------------------------------------------- ----------");
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.");
                        avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle- exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará.";
                        console.log("Horário do último dado capturado:");
                        console.log(dados.labels[dados.labels.length - 1]);
                        console.log("----------------------------------------------------- ----------");
                    } else {
                        // Remove o primeiro item dos labels e dos dados
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].tempo); // incluir um novo momento
                        // Remove o primeiro item dos dados de umidade e temperatura e adiciona o novo dado
                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].pontos); // incluir uma nova medida de umidade
                        // Atualiza o gráfico
                        myChart.update();
                    }
                    // Define um novo intervalo para atualizar o gráfico após 2 segundos
                    setTimeout(() => atualizarGrafico(dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Define um novo intervalo para atualizar o gráfico após 2 segundos
                setTimeout(() => atualizarGrafico(dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
</script>