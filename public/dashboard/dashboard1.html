<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaTech | Dashboards</title>
    <link rel="stylesheet" href="./../css/dashboard.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="janela">
        <div class="header-left">
            <h1>AquaTech</h1>

            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="btn-nav-white">
                <a href="./cards.html">
                    <h3>Aquários</h3>
                </a>
            </div>

            <div class="btn-nav">
                <h3>Gráficos</h3>
            </div>

            <div class="btn-nav-white">
                <a href="./mural.html">
                    <h3>Mural</h3>
                </a>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>
        </div>

        <div class="dash">
            <div id="alerta">
            </div>

            <div class="btns-dash" id="btnAquario">
                <!-- O gráfico é chamado de acordo com o id (fk_aquario) do banco  -->
            </div>

            <div id="graficos">
                <div class="chart">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
    </div>

</body>

</html>
<script>

    window.onload = async () => {
        obterDadosGrafico(sessionStorage.ID_USUARIO);
    };

    let pontosCC = [];
    let qntAzul = [];
    let qntLaranja = [];
    let qntAmarelo = [];
    let qntRoxo = [];
    let qntRosa = [];
    let qntVerde = [];
    let qntBranco = [];
    let jogoAtual = [];

    // Função para obter os dados do gráfico do banco de dados
    function obterDadosGrafico(fkFazendeiro) {
        fetch(`/jogo2/buscarUltimosPontosCC/${fkFazendeiro}`)
            .then(function (response) {
                if (response.ok) {

                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        for (let i = 0; i < resposta.length; i++) {
                            // Adiciona a data e hora do registro aos labels
                            // Adiciona a umidade e a temperatura aos dados
                            pontosCC.push(resposta[i].pontosCC);
                            qntAzul.push(resposta[i].qntAzul);
                            qntLaranja.push(resposta[i].qntLaranja);
                            qntAmarelo.push(resposta[i].qntAmarelo);
                            qntRoxo.push(resposta[i].qntRoxo);
                            qntRosa.push(resposta[i].qntRosa);
                            qntVerde.push(resposta[i].qntVerde);
                            qntBranco.push(resposta[i].qntBranco);
                            jogoAtual.push(resposta[i].idJogoCC);
                        }
                        sessionStorage.setItem('JogosCC', JSON.stringify(resposta));
                        // Plota o gráfico com os dados recebidos
                        plotarGrafico(resposta, fkFazendeiro);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }
    // Função para plotar o gráfico na página
    console.log('bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb');
    function plotarGrafico(resposta, fkFazendeiro) {
        console.log('iniciando plotagem do gráfico...');
        // Cria a estrutura para plotar o gráfico - labels (eixo x)
        let labels = [];
        // Cria a estrutura para plotar o gráfico - dados (eixo y)
        let dados = {
            labels: jogoAtual,
            datasets: [

                {
                    label: 'qntBranco',
                    data: qntBranco,
                    fill: true,
                    borderColor: 'white',
                    tension: 0.1,
                },
                {
                    label: 'qntAzul',
                    data: qntAzul,
                    fill: true,
                    borderColor: 'lightblue',
                    tension: 0.1,
                },
                {
                    label: 'qntLaranja',
                    data: qntLaranja,
                    fill: true,
                    borderColor: 'orange',
                    tension: 0.1,
                },
                {
                    label: 'qntAmarelo',
                    data: qntAmarelo,
                    fill: true,
                    borderColor: 'yellow',
                    tension: 0.1,
                },
                {
                    label: 'qntRoxo',
                    data: qntRoxo,
                    fill: true,
                    borderColor: 'purple',
                    tension: 0.1,
                },
                {
                    label: 'qntRosa',
                    data: qntRosa,
                    fill: true,
                    borderColor: 'pink',
                    tension: 0.1,
                },
                {
                    label: 'qntVerde',
                    data: qntVerde,
                    fill: true,
                    borderColor: 'green',
                    tension: 0.1,
                }, 
                {
                    label: 'Pontos',
                    type: 'bar',
                    data: pontosCC,
                    backgroundColor: 'blue',
                    fill: true,
                    borderColor: 'green',
                    tension: 0.1,
                },
            ],
        };
        console.log('----------------------------------------------');
        console.log(
            'Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":'
        );
        console.log(resposta);
        // Itera sobre cada registro de dados

        console.log('----------------------------------------------');
        console.log('O gráfico será plotado com os respectivos valores:');
        console.log('Labels:');
        console.log(labels);
        console.log('Dados:');
        console.log(dados.datasets);
        console.log('----------------------------------------------');
        // Cria a configuração para o gráfico
        const config = {
            type: 'line', // Define o tipo de gráfico como linha
            data: dados, // Define os dados do gráfico
        };
        // Cria o gráfico e o adiciona à div na página
        let myChart = new Chart(
            document.getElementById(`myChart`),
            config
        );
    }

</script>